{% extends "base.html" %}
{% block content %}
<head>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Font Awesome CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Tailwind CSS (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
</head>
<body>
    <div class="container mx-auto p-6 max-w-4xl">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Left Section: Inputs and Calendar -->
            <div class="w-full md:w-1/2 bg-white p-6 rounded-lg shadow-lg">
                <div class="space-y-4">
                    <!-- Travel Destination Input -->
                    <div class="input-group">
                        <i class="fas fa-map-marker-alt absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        <input type="text" id="travel-destination" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß" class="w-full pl-10 pr-4 py-2 border-purple-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <!-- Number of People Input -->
                    <div class="input-group">
                        <i class="fas fa-users absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        <input type="number" id="number-of-people" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô" class="w-full pl-10 pr-4 py-2 border-purple-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <!-- Location Input -->
                    <div class="input-group">
                        <i class="fas fa-map-marker-alt absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        <input type="text" id="location-input" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" class="w-full pl-10 pr-4 py-2 border-purple-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button type="button" id="get-location-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-purple-500 hover:text-purple-700">
                            <i class="fa fa-paper-plane" style="font-size: 16px;"></i>
                        </button>
                    </div>

                    <!-- Calendar -->
                    <div class="calendar bg-gray-50 p-4 rounded-lg shadow-inner">
                        <input type="text" id="calendar-input" placeholder="" class="w-full focus:outline-none days">
                    </div>
                    <button class="btn" id="generateBtn">Generate</button>
                </div>
            </div>

            <!-- Right Section: Random Trip -->
            <div class="trip-image-container">
                <a id="place-link">
                    <div class="trip-title-overlay">
                        <p id="place-title">Loading...</p>
                    </div>
                    <img id="place-image" src="{{ url_for('static', filename='images/default_trip.jpg') }}" 
                        alt="Random Trip" />
                    <div class="trip-location-overlay">
                        <p id="province-title"></p> <!-- ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î -->
                    </div>
                </a>
            </div>
        </div>
    </div>
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>
    

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.getElementById('get-location-btn').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å OpenStreetMap Nominatim API
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        
                        if (data.display_name) {
                            document.getElementById('location-input').value = data.display_name;
                        } else {
                            document.getElementById('location-input').value = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà";
                        }
                    } catch (error) {
                        alert('‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
                    }

                }, function(error) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: ' + error.message);
                });
            } else {
                alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
            }
        });

        document.getElementById('generateBtn').addEventListener('click', async function() {
            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            const province = document.getElementById('travel-destination').value;
            const dateRange = document.getElementById('calendar-input').value; // ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            const numPeople = document.getElementById('number-of-people').value; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
            const location = document.getElementById('location-input').value;
            
            if (!province || !dateRange || !numPeople) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î, ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô');
                document.getElementById('loading').style.display = 'none';
                return;
            }
            
            try {
                // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
                const response = await fetch('/get_trips', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        province: province,
                        date: dateRange,
                        num_people: numPeople,
                        location: location
                    })
                });

                if (response.ok) {
                    const trips = await response.json();
                    sessionStorage.setItem('trips', JSON.stringify(trips));
                    window.location.href = '/trip';
                } else {
                    throw new Error('Failed to generate trips');
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏£‡∏¥‡∏õ: ' + error.message);
                loading.style.display = 'none';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });
        flatpickr("#calendar-input", {
            inline: true,           // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
            mode: "range",       // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            dateFormat: "d-m-Y",    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            minDate: "today",       // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            theme: "light",         // ‡πÉ‡∏ä‡πâ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏™‡∏ß‡πà‡∏≤‡∏á
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", async function() {
            try {
                let response = await fetch("/random_place"); 
                let trip = await response.json();
        
                if (!trip.error) {
                    document.getElementById("place-title").textContent = trip.title || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏¥‡∏õ"; // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏¥‡∏õ
                    document.getElementById("province-title").textContent = "üìç " + trip.province; // ‡πÉ‡∏™‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                    document.getElementById("place-image").src = trip.image; // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏£‡∏¥‡∏õ
                    document.getElementById("place-link").href = `/location/random_trip`; // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                } else {
                    document.getElementById("place-title").textContent = "No trips available";
                }
            } catch (error) {
                console.error("Error fetching trip:", error);
            }
        });
    </script>
</body>
{% endblock %}